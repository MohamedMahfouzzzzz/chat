<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <title>Chat App</title>
  <style>
    /* Global Variables */
:root {
  --primary-color: #007bff;
  --primary-hover: #0056b3;
  --secondary-color: #fafafa;
  --text-color: #333;
  --border-color: #ddd;
  --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  --border-radius: 8px;
  --font-family: 'Arial', sans-serif;
}

/* General Styles */
body {
  font-family: var(--font-family);
  margin: 0;
  padding: 0;
  background-color: var(--secondary-color);
  color: var(--text-color);
}

.wrapper {
  display: flex;
  max-width: 800px;
  margin: 20px auto;
  background-color: #fff;
  border: 1px solid var(--border-color);
  border-radius: var(--border-radius);
  overflow: hidden;
  box-shadow: var(--box-shadow);
}

/* Users Section */
.users {
  flex: 1;
  padding: 20px;
  border-right: 1px solid var(--border-color);
  background-color: var(--secondary-color);
}

.users header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.users header h2 {
  font-size: 18px;
  margin: 0;
}

.users header button {
  background-color: var(--primary-color);
  color: #fff;
  border: none;
  padding: 8px 12px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.users header button:hover {
  background-color: var(--primary-hover);
}

.search {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

.search input {
  flex: 1;
  padding: 8px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
}

.search button {
  background-color: var(--primary-color);
  color: #fff;
  border: none;
  padding: 8px;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease;
}

.search button:hover {
  background-color: var(--primary-hover);
}

.users-list {
  margin-top: 20px;
  list-style: none;
  padding: 0;
}

.users-list li {
  cursor: pointer;
  padding: 10px;
  border: 1px solid var(--border-color);
  margin-bottom: 5px;
  border-radius: 5px;
  background-color: #fff;
  transition: background-color 0.2s ease, box-shadow 0.2s ease;
}

.users-list li:hover {
  background-color: var(--secondary-color);
  box-shadow: var(--box-shadow);
}

/* Chat Section */
.chat {
  flex: 2;
  padding: 20px;
  display: flex;
  flex-direction: column;
  background-color: #fff;
}

.chat header {
  margin-bottom: 10px;
}

.chat header .user-name {
  font-weight: bold;
  font-size: 16px;
}

.chat-box {
  flex: 1;
  max-height: 400px;
  overflow-y: auto;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  background-color: var(--secondary-color);
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.chat-box div {
  display: flex;
  flex-wrap: wrap;
}

/* Message Bubbles */
.sent,
.received {
  padding: 10px;
  margin: 5px 0;
  border-radius: 10px;
  max-width: 60%;
  word-wrap: break-word;
}

.sent {
  background-color: #daf8cb;
  color: #000;
  align-self: flex-end;
}

.received {
  background-color: #f0f0f0;
  color: #000;
  align-self: flex-start;
}

.chat-box small {
  display: block;
  margin-top: 4px;
  font-size: 0.8em;
  color: gray;
  text-align: right; /* Adjust to left or right based on message alignment */
}

/* Message Input */
.send-message {
  margin-top: 10px;
  display: flex;
  gap: 10px;
}

.send-message input {
  flex: 1;
  padding: 10px;
  border: 1px solid var(--border-color);
  border-radius: 5px;
  box-sizing: border-box;
  transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

.send-message input:focus {
  outline: none;
  border-color: var(--primary-color);
  box-shadow: 0 0 4px rgba(0, 123, 255, 0.5);
}

/* Reaction Menu */
/* Reaction List Below the Message */
.message-reactions {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-start; /* Adjust alignment as needed */
  gap: 5px; /* Add spacing between reactions */
  margin-top: 5px; /* Spacing between the message and reactions */
  font-size: 14px; /* Adjust the font size of the reactions */
}

.message-reactions .reaction-item {
  display: flex;
  align-items: center;
  background-color: #f0f0f0;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 0.9em;
  cursor: pointer;
  transition: background-color 0.2s ease;
}

.message-reactions .reaction-item:hover {
  background-color: #e0e0e0;
}

.message-reactions .reaction-item span {
  margin-left: 4px; /* Space between the emoji and count */
}


/* Responsive Styles */
@media (max-width: 600px) {
  .wrapper {
    flex-direction: column;
    max-width: 100%;
    margin: 10px;
  }

  .users {
    border-right: none;
    border-bottom: 1px solid var(--border-color);
  }

  .chat-box {
    max-height: 300px;
  }
}

/* Reaction Menu Styles */
.reaction-menu {
  display: none; /* Initially hidden */
  position: absolute;
  bottom: 60px; /* Adjust as needed */
  left: 20px; /* Adjust as needed */
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 10px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  z-index: 1000;
}

.reaction-menu .reaction {
  margin: 5px;
  font-size: 18px;
  cursor: pointer;
}

.reaction-menu .reaction:hover {
  background: #f0f0f0;
  border-radius: 4px;
}


  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Users Section -->
    <section class="users">
      <header>
        <h2>Welcome, <span id="welcome-name">User</span>!</h2>
        <button id="logout-btn" aria-label="Logout">Logout</button>
      </header>
      <div class="search">
        <input type="text" placeholder="Search users" aria-label="Search users">
        <button type="submit" aria-label="Search"><i class="fa fa-search"></i></button>
      </div>
      <ul class="users-list">
        <!-- Loading placeholder -->
        <li>Loading users...</li>
      </ul>
    </section>

    <!-- Chat Section -->
    <section class="chat">
      <header>
        <div class="user-details">
          <span class="user-name">Chat with: <span id="chatting-user-name">No one</span></span>
        </div>
      </header>
      <div class="chat-box">
        <!-- Placeholder message -->
        <p>No messages yet. Start a conversation!</p>
      </div>
      <div id="reaction-menu" class="reaction-menu">
        <button class="reaction" data-reaction="üëç" aria-label="Thumbs Up" onclick="addReaction('üëç')">üëç</button>
        <button class="reaction" data-reaction="‚ù§Ô∏è" aria-label="Heart" onclick="addReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
        <button class="reaction" data-reaction="üòÇ" aria-label="Laugh" onclick="addReaction('üòÇ')">üòÇ</button>
        <button class="reaction" data-reaction="üòÆ" aria-label="Surprise" onclick="addReaction('üòÆ')">üòÆ</button>
      </div>
      <div class="send-message">
        <input type="text" class="input-message" placeholder="Type a message" aria-label="Type a message">
        <button id="send-btn" aria-label="Send message">Send</button>
      </div>
    </section>
  </div>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js';
import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
import { getFirestore, collection, getDocs, setDoc, doc, getDoc, updateDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js';

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyBV67s1bVA5mPUdRJDMYtg0QXAviHGj0LE",
  authDomain: "chattest-fa7a1.firebaseapp.com",
  projectId: "chattest-fa7a1",
  storageBucket: "chattest-fa7a1.appspot.com",
  messagingSenderId: "124598075226",
  appId: "1:124598075226:web:eb626080a09fd453283d63",
  measurementId: "G-FFFY13W0DH"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

document.addEventListener("DOMContentLoaded", () => {
  const usersList = document.querySelector('.users-list');
  const chatBox = document.querySelector('.chat-box');
  const inputMessage = document.querySelector('.input-message');
  const sendBtn = document.getElementById('send-btn');
  const chattingUserName = document.getElementById('chatting-user-name');
  const welcomeName = document.getElementById('welcome-name');
  const logoutBtn = document.getElementById('logout-btn');
  const reactionMenu = document.getElementById('reaction-menu');
  let selectedUserId = null;
  let chatId = null;
  let selectedMessageId = null;

  // Request notification permission
  function requestNotificationPermission() {
    if ('Notification' in window) {
      Notification.requestPermission().then((permission) => {
        if (permission === 'granted') {
          console.log('Notification permission granted.');
        } else {
          console.warn('Notification permission denied.');
        }
      }).catch((error) => {
        console.error('Error requesting notification permission:', error);
      });
    } else {
      console.warn('Notifications are not supported in this browser.');
    }
  }

  // Call notification permission request when the page loads
  requestNotificationPermission();

  window.onfocus = () => {
    document.title = "Mochat";
  };

  window.onblur = () => {
    document.title = "Mochat (Away)";
  };

  function linkify(text) {
    const urlPattern = /(\bhttps?:\/\/[^\s]+)/g;
    return text.replace(urlPattern, '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');
  }

  function formatTimestamp(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true, month: 'short', day: 'numeric' });
  }

  onAuthStateChanged(auth, async (user) => {
    if (user) {
      try {
        const userDoc = await getDoc(doc(db, "users", user.uid));
        if (userDoc.exists()) {
          welcomeName.textContent = userDoc.data().name;
        } else {
          const userName = prompt("Please enter your name:");
          if (userName && userName.trim() !== "") {
            await setDoc(doc(db, "users", user.uid), {
              name: userName,
              uid: user.uid,
              email: user.email
            });
            welcomeName.textContent = userName;
          }
        }
        loadUsers();
      } catch (error) {
        console.error("Error loading user:", error);
      }
    } else {
      window.location.href = 'login.html';
    }
  });

  logoutBtn.addEventListener('click', async () => {
    try {
      await signOut(auth);
      console.log('User logged out');
    } catch (error) {
      console.error('Logout error:', error);
    }
  });

  async function loadUsers() {
    try {
      const querySnapshot = await getDocs(collection(db, "users"));
      usersList.innerHTML = '';
      querySnapshot.forEach((doc) => {
        const user = doc.data();
        const userItem = document.createElement('li');
        userItem.textContent = user.name;
        userItem.dataset.id = doc.id;
        userItem.dataset.name = user.name;
        usersList.appendChild(userItem);
      });
    } catch (error) {
      console.error("Error loading users:", error);
    }
  }

  function startChat(userId, userName) {
    const currentUserId = auth.currentUser.uid;
    selectedUserId = userId;
    chatId = currentUserId < selectedUserId ? `${currentUserId}_${selectedUserId}` : `${selectedUserId}_${currentUserId}`;
    chattingUserName.textContent = userName;

    const messagesRef = collection(db, 'chats', chatId, 'messages');
    onSnapshot(messagesRef, (snapshot) => {
      chatBox.innerHTML = '';
      snapshot.forEach((doc) => {
        const message = doc.data();
        const messageElement = document.createElement('div');
        messageElement.classList.add(message.sender === currentUserId ? 'sent' : 'received');
        messageElement.dataset.id = doc.id;

        const messageText = document.createElement('p');
        messageText.innerHTML = linkify(message.text);

        const messageTimestamp = document.createElement('small');
        if (message.timestamp) {
          messageTimestamp.textContent = formatTimestamp(message.timestamp.toMillis());
        }

        messageElement.appendChild(messageText);
        messageElement.appendChild(messageTimestamp);

        // Display reaction counts
        if (message.reactions) {
          const reactionContainer = document.createElement('div');
          for (let emoji in message.reactions) {
            const reactionCount = message.reactions[emoji];
            const reactionElement = document.createElement('span');
            reactionElement.innerText = `${emoji} ${reactionCount}`;
            reactionContainer.appendChild(reactionElement);
          }
          messageElement.appendChild(reactionContainer);
        }

        chatBox.appendChild(messageElement);

        // Right-click reaction menu
        messageElement.addEventListener('contextmenu', (event) => {
          event.preventDefault();
          selectedMessageId = doc.id;
          reactionMenu.style.top = `${event.clientY}px`;
          reactionMenu.style.left = `${event.clientX}px`;
          reactionMenu.style.display = 'block';
        });
      });

      chatBox.scrollTop = chatBox.scrollHeight;
    });
  }

  usersList.addEventListener('click', (event) => {
    if (event.target.tagName === 'LI') {
      startChat(event.target.dataset.id, event.target.dataset.name);
    }
  });

  function sendMessage() {
    if (inputMessage.value.trim()) {
      const messageText = inputMessage.value.trim();
      setDoc(doc(collection(db, 'chats', chatId, 'messages'), new Date().getTime().toString()), {
        text: messageText,
        sender: auth.currentUser.uid,
        timestamp: serverTimestamp(),
        reactions: {}
      }).then(() => {
        inputMessage.value = '';
      }).catch((error) => {
        console.error("Error sending message:", error);
      });
    }
  }

  async function addReaction(reaction) {
    if (!selectedMessageId) return;

    const messageDoc = doc(db, 'chats', chatId, 'messages', selectedMessageId);
    const messageSnap = await getDoc(messageDoc);

    if (messageSnap.exists()) {
      const messageData = messageSnap.data();
      const reactions = messageData.reactions || {};

      if (reactions[reaction]) {
        reactions[reaction]++;
      } else {
        reactions[reaction] = 1;
      }

      await updateDoc(messageDoc, { reactions });
    }
    reactionMenu.style.display = 'none';
  }

  sendBtn.addEventListener('click', sendMessage);
  inputMessage.addEventListener('keypress', (event) => {
    if (event.key === 'Enter') {
      sendMessage();
    }
  });

  document.addEventListener('click', () => {
    reactionMenu.style.display = 'none';
  });

  window.addReaction = async function (reaction) {
    if (!selectedMessageId) return;
  
    const messageDoc = doc(db, 'chats', chatId, 'messages', selectedMessageId);
    const messageSnap = await getDoc(messageDoc);
  
    if (messageSnap.exists()) {
      const messageData = messageSnap.data();
      const reactions = messageData.reactions || {};
  
      if (reactions[reaction]) {
        reactions[reaction]++;
      } else {
        reactions[reaction] = 1;
      }
  
      await updateDoc(messageDoc, { reactions });
    }
    reactionMenu.style.display = 'none';
  };
  
});

  </script>
</body>
</html>
